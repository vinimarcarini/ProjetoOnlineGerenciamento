(function(n){n.fn.addTyping=function(t){var i={showTyping:!0,delay:250};return this.each(function(){var r=n(this).data("keyboard");r&&(r.typing_options=n.extend({},i,t),r.typing_keymap={" ":"space",'"':"34","'":"39","&nbsp;":"space","\b":"bksp","\n":"Enter","\r":"Enter","\t":"tab"},r.typing_xref={8:"bksp",9:"tab",13:"enter",32:"space"},r.typing_event=r.typing_flag=!1,r.typing_setup=function(){if(!r.typing_flag){r.typing_flag=!0;var n=r.$preview?r.$preview:r.$el;n.bind("keyup.keyboard",function(n){if((!(n.which>=37)||!(n.which<=40))&&(n.which===16&&(r.shiftActive=!1),n.which===18&&(r.altActive=!1),n.which===16||n.which===18)){r.showKeySet(),setTimeout(function(){r.$preview.focus()},200);return}}).bind("keydown.keyboard",function(n){n.temp=!1,n.which===16&&(n.temp=r.shiftActive?!1:!0,r.shiftActive=!0),n.which===18&&(n.temp=r.altActive?!1:!0,r.altActive=!0),n.temp&&(r.showKeySet(),r.$preview.focus()),r.typing_event=!0,(n.which===8||n.which===9)&&r.typeIn("",r.typing_options.delay||250,function(){r.typing_event=!1},n)}).bind("keypress.keyboard",function(n){r.typing_event&&!r.options.lockInput&&r.typeIn("",r.typing_options.delay||250,function(){r.typing_event=!1},n)})}},r.typeIn=function(t,i,u,f){if(!r.isVisible()){r.typing_options.init=!1,clearTimeout(r.typing_timer);return}var e=r.typing_options,s,a,h,y,o,c,l,v;if(r.typing_options.init!==!0&&(e.init=!0,e.text=t,e.len=t.length,e.delay=i||300,e.current=0,e.callback=u),t=e.text.substring(e.current,++e.current),c=r.$keyboard.find(".ui-keyboard-keyset"),y=r.typing_keymap.hasOwnProperty(t)?r.typing_keymap[t]:t,s='.ui-keyboard-button[data-value="'+y+'"]',r.typing_event&&f&&(r.typing_xref.hasOwnProperty(f.keyCode||f.which)?s=".ui-keyboard-"+r.typing_xref[f.keyCode||f.which]:(a=String.fromCharCode(f.charCode||f.which),s=r.mappedKeys.hasOwnProperty(a)?'.ui-keyboard-button[data-value="'+r.mappedKeys[a]+'"]':".ui-keyboard-"+(f.charCode||f.which))),o=c.filter(":visible").find(s),o.length?r.typing_simulateKey(o,t):(r.typing_event?o=c.find(s):(h=r.typing_keymap.hasOwnProperty(t)?r.typing_keymap[t]:t.charCodeAt(0),h==="bksp"&&(t=h),o=c.find(".ui-keyboard-"+h)),v=o.closest(".ui-keyboard-keyset"),v.attr("name")?(l=v.attr("name"),r.shiftActive=/shift/.test(l),r.altActive=/alt/.test(l),r.metaActive=r.lastKeyset[2]=l.match(/meta\d+/)||!1,r.showKeySet({name:r.metaActive}),r.typing_simulateKey(o,t)):r.typing_event||(r.insertText(t),r.checkCombos())),e.current<e.len){if(!r.isVisible())return;setTimeout(function(){r.typeIn()},e.delay)}else{e.init=!1,n.isFunction(e.callback)&&setTimeout(function(){e.callback(r)},e.delay);return}},r.typing_simulateKey=function(n,t){var i=n.length;i&&n.filter(":visible").trigger("mouseenter.keyboard"),r.typing_timer=setTimeout(function(){(i&&setTimeout(function(){n.trigger("mouseleave.keyboard")},r.typing_options.delay/3),r.isVisible())&&(r.typing_event||(r.insertText(t),r.checkCombos()))},r.typing_options.delay/3)},r.typing_options.showTyping&&(r.options.alwaysOpen&&r.isVisible()&&r.typing_setup(),r.$el.bind("visible.keyboard",function(){r.typing_setup()})))})}})(jQuery)